#!/usr/bin/env ruby

ROOT_DIR = File.join(File.dirname(__FILE__), '..')

Dir.chdir ROOT_DIR do
  require 'bundler/setup'
end

$LOAD_PATH.unshift(File.join(ROOT_DIR, 'lib'))

require 'cli'
require 'generate'
require 'environment_config_transmogrifier'

options = {}
parser = Cli.make_option_parser(options)

parser.parse!(ARGV)
options[:template] = ARGV.last

begin
  Cli.check_opts(options)
rescue ArgConflictError => e
  STDERR.puts("invalid arguments: #{e}")
  exit(1)
rescue ArgMissingError => e
  STDERR.puts("missing argument: #{e}")
  exit(1)
end

base_config = JSON.parse(File.read(options[:base]))
templates = YAML::load_file(options[:templates])

transmogrifier = EnvironmentConfigTransmogrifier.new(base_config, templates)
bosh_spec = transmogrifier.transmogrify

Generate.generate(output: options[:output], data: bosh_spec.to_json) do |output_stream, huge_config|
  Generate.render(output_stream, huge_config, options[:input])
end
