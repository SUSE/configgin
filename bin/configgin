#!/usr/bin/env ruby

ROOT_DIR = File.join(File.dirname(__FILE__), '..')

Dir.chdir ROOT_DIR do
  require 'bundler/setup'
end

$LOAD_PATH.unshift(File.join(ROOT_DIR, 'lib'))

require 'cli'
require 'generate'

options = {}
parser = Cli.make_option_parser(options)

parser.parse!(ARGV)
options[:template] = ARGV.last

begin
  Cli.check_opts(options)
rescue ArgConflictError => e
  STDERR.puts("invalid arguments: #{e}")
  exit(1)
rescue ArgMissingError => e
  STDERR.puts("missing argument: #{e}")
  exit(1)
end

config_store = ConsulConfigStore.new(options[:consul], options[:prefix], options[:job], options[:role])

Generate.generate(output: options[:output], input: options[:input], data: options[:data]) do
  Generate.render(output, input, options[:template], config_store)
end
